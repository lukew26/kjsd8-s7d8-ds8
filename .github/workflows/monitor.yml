name: 24-7 Giveaway Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # Backup trigger every 6 hours

permissions:
  contents: write
  actions: write 

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Dependencies
      run: pip install requests python-dotenv

    - name: Connect VPN
      run: |
        sudo apt-get update && sudo apt-get install -y openvpn
        echo "${{ secrets.VPN_CONFIG }}" > vpn.ovpn
        echo -e "${{ secrets.VPN_USER }}\n${{ secrets.VPN_PASS }}" > vpn_creds.txt
        sudo openvpn --config vpn.ovpn --auth-user-pass vpn_creds.txt --daemon

    - name: Run Monitor
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        DISCORD_ROLE_ID: ${{ secrets.DISCORD_ROLE_ID }}
      # Run for 5 hours and 30 minutes, then signal exit
      # We use --signal=SIGINT so your Python script catches the stop signal
      run: timeout --signal=SIGINT 330m python ORIGINAL.py || true

    - name: Save State and Relay
      if: always()
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git pull origin main --rebase || true
        git add seen_posts.txt metrics.json last_shutdown.txt
        git commit -m "Relay state update [skip ci]" && git push || echo "No changes"
        
        # Trigger the next 6-hour block
        gh workflow run "24-7 Giveaway Monitor"
